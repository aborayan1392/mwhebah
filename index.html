<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الموهوبين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#059669'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin: 0;
                padding: 0;
            }
            .print-container {
                margin: 0;
                padding: 15px;
                box-shadow: none;
                width: 100%;
                max-width: none;
            }
            
            /* إعدادات خاصة بالجدول في الطباعة */
            .table-container {
                overflow: visible !important;
                width: 100% !important;
                margin: 0 !important;
            }
            
            table {
                width: 100% !important;
                min-width: auto !important;
                font-size: 11px !important;
                page-break-inside: avoid;
            }
            
            th, td {
                padding: 6px 4px !important;
                font-size: 10px !important;
                border: 1px solid #000 !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            
            th {
                background-color: #5D5CDE !important;
                color: white !important;
                font-weight: bold !important;
                text-align: center !important;
            }
            
            /* تحسين عروض الأعمدة للطباعة */
            th:nth-child(1), td:nth-child(1) { width: 5% !important; } /* # */
            th:nth-child(2), td:nth-child(2) { width: 20% !important; } /* الاسم */
            th:nth-child(3), td:nth-child(3) { width: 15% !important; } /* المرحلة */
            th:nth-child(4), td:nth-child(4) { width: 8% !important; } /* الصف */
            th:nth-child(5), td:nth-child(5) { width: 17% !important; } /* مجال الموهبة */
            th:nth-child(6), td:nth-child(6) { width: 12% !important; } /* مستوى الموهبة */
            th:nth-child(7), td:nth-child(7) { width: 23% !important; } /* ملاحظات */
            
            /* إخفاء رسالة التمرير في الطباعة */
            .text-center.text-xs {
                display: none !important;
            }
            
            /* ضبط الهوامش والحاوي الرئيسي */
            .container {
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* تحسين الكليشة */
            .flex.justify-between.items-center {
                margin-bottom: 20px !important;
            }
            
            /* ضمان ظهور الشعارات في الطباعة */
            img {
                max-height: 60px !important;
                max-width: 60px !important;
                width: auto !important;
                height: auto !important;
                object-fit: contain !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                opacity: 1 !important;
                visibility: visible !important;
                display: block !important;
            }
            
            /* تحسين العناوين */
            h1, h2, h3 {
                margin: 5px 0 !important;
            }
            
            /* تحسين الإحصائيات */
            .grid.md\\:grid-cols-4 {
                display: none !important;
            }
            
            .grid.md\\:grid-cols-2 {
                display: none !important;
            }
            
            /* فورس الصفحة للاتجاه العمودي */
            @page {
                size: A4 portrait;
                margin: 1cm 0.5cm;
            }
        }
        
        .logo-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 no-print">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-primary mb-2">تطبيق إدارة الموهوبين</h1>
                <p class="text-gray-600 dark:text-gray-400">نظام شامل لإدارة وتتبع الطلاب الموهوبين</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6 no-print">
            <div class="flex flex-wrap justify-center gap-2">
                <button id="settingsTab" class="tab-btn bg-primary text-white px-4 py-2 rounded-lg font-medium">إعدادات المدرسة</button>
                <button id="studentsTab" class="tab-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium">إدارة الطلاب</button>
                <button id="reportsTab" class="tab-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium">التقارير</button>
            </div>
        </nav>

        <!-- Settings Tab -->
        <div id="settingsContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4">إعدادات المدرسة</h2>
                
                <div class="max-w-md">
                    <div>
                        <label class="block text-sm font-medium mb-2">اسم المدرسة</label>
                        <input type="text" id="schoolName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button id="saveSettings" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">حفظ الإعدادات</button>
                    <button id="clearSettings" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">مسح الإعدادات</button>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="studentsContent" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-primary mb-4">إضافة طالب موهوب</h2>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">الاسم</label>
                        <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">المرحلة</label>
                        <select id="studentStage" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر المرحلة</option>
                            <option value="أول ابتدائي">أول ابتدائي</option>
                            <option value="ثاني ابتدائي">ثاني ابتدائي</option>
                            <option value="ثالث ابتدائي">ثالث ابتدائي</option>
                            <option value="رابع ابتدائي">رابع ابتدائي</option>
                            <option value="خامس ابتدائي">خامس ابتدائي</option>
                            <option value="سادس ابتدائي">سادس ابتدائي</option>
                            <option value="أول متوسط">أول متوسط</option>
                            <option value="ثاني متوسط">ثاني متوسط</option>
                            <option value="ثالث متوسط">ثالث متوسط</option>
                            <option value="أول ثانوي">أول ثانوي</option>
                            <option value="ثاني ثانوي">ثاني ثانوي</option>
                            <option value="ثالث ثانوي">ثالث ثانوي</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">الصف</label>
                        <select id="studentClass" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر رقم الصف</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">مجال الموهبة</label>
                        <select id="talentField" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر مجال الموهبة</option>
                            <option value="الرياضيات">الرياضيات</option>
                            <option value="العلوم">العلوم</option>
                            <option value="اللغة العربية">اللغة العربية</option>
                            <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                            <option value="الفنون">الفنون</option>
                            <option value="الموسيقى">الموسيقى</option>
                            <option value="الرياضة">الرياضة</option>
                            <option value="التكنولوجيا">التكنولوجيا</option>
                            <option value="الابتكار">الابتكار</option>
                            <option value="القيادة">القيادة</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">مستوى الموهبة</label>
                        <select id="talentLevel" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">اختر مستوى الموهبة</option>
                            <option value="ممتاز">ممتاز</option>
                            <option value="جيد جداً">جيد جداً</option>
                            <option value="جيد">جيد</option>
                            <option value="مقبول">مقبول</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">ملاحظات</label>
                        <textarea id="studentNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base"></textarea>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button id="addStudent" class="bg-secondary text-white px-6 py-2 rounded-lg hover:bg-secondary/90 transition-colors">إضافة الطالب</button>
                    <button id="clearForm" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">مسح النموذج</button>
                </div>
            </div>
            
            <!-- Students List -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-primary mb-4">قائمة الطلاب الموهوبين</h3>
                <div id="studentsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsContent" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 no-print">
                <h2 class="text-xl font-bold text-primary mb-4">التقارير</h2>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">فلترة حسب المرحلة</label>
                        <select id="filterStage" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">جميع المراحل</option>
                            <option value="أول ابتدائي">أول ابتدائي</option>
                            <option value="ثاني ابتدائي">ثاني ابتدائي</option>
                            <option value="ثالث ابتدائي">ثالث ابتدائي</option>
                            <option value="رابع ابتدائي">رابع ابتدائي</option>
                            <option value="خامس ابتدائي">خامس ابتدائي</option>
                            <option value="سادس ابتدائي">سادس ابتدائي</option>
                            <option value="أول متوسط">أول متوسط</option>
                            <option value="ثاني متوسط">ثاني متوسط</option>
                            <option value="ثالث متوسط">ثالث متوسط</option>
                            <option value="أول ثانوي">أول ثانوي</option>
                            <option value="ثاني ثانوي">ثاني ثانوي</option>
                            <option value="ثالث ثانوي">ثالث ثانوي</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">فلترة حسب مجال الموهبة</label>
                        <select id="filterTalent" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">جميع المجالات</option>
                            <option value="الرياضيات">الرياضيات</option>
                            <option value="العلوم">العلوم</option>
                            <option value="اللغة العربية">اللغة العربية</option>
                            <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                            <option value="الفنون">الفنون</option>
                            <option value="الموسيقى">الموسيقى</option>
                            <option value="الرياضة">الرياضة</option>
                            <option value="التكنولوجيا">التكنولوجيا</option>
                            <option value="الابتكار">الابتكار</option>
                            <option value="القيادة">القيادة</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">فلترة حسب مستوى الموهبة</label>
                        <select id="filterLevel" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-base">
                            <option value="">جميع المستويات</option>
                            <option value="ممتاز">ممتاز</option>
                            <option value="جيد جداً">جيد جداً</option>
                            <option value="جيد">جيد</option>
                            <option value="مقبول">مقبول</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button id="printReport" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors w-full">طباعة التقرير</button>
                    </div>
                </div>
            </div>
            
            <!-- Report Content -->
            <div id="reportContent" class="bg-white rounded-lg shadow-md print-container">
                <!-- Report will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // IndexedDB setup
        let db;
        const dbName = 'TalentedStudentsDB';
        const dbVersion = 1;

        const initDB = () => {
            const request = indexedDB.open(dbName, dbVersion);
            
            request.onerror = () => {
                console.error('Database error:', request.error);
            };
            
            request.onsuccess = () => {
                db = request.result;
                loadSettings();
                loadStudents();
                generateReport();
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                // Settings store
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                
                // Students store
                if (!db.objectStoreNames.contains('students')) {
                    const studentsStore = db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
                    studentsStore.createIndex('stage', 'stage', { unique: false });
                    studentsStore.createIndex('talentField', 'talentField', { unique: false });
                }
            };
        };

        // Populate class numbers
        const populateClassNumbers = () => {
            const classSelect = document.getElementById('studentClass');
            classSelect.innerHTML = '<option value="">اختر رقم الصف</option>';
            for (let i = 1; i <= 15; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                classSelect.appendChild(option);
            }
        };

        // Tab functionality
        const initTabs = () => {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.id.replace('Tab', 'Content');
                    
                    // Update tab styles
                    tabs.forEach(t => {
                        t.classList.remove('bg-primary', 'text-white');
                        t.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    tab.classList.add('bg-primary', 'text-white');
                    tab.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    
                    // Show/hide content
                    contents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    // Generate report when reports tab is opened
                    if (tabId === 'reportsContent') {
                        generateReport();
                    }
                });
            });
        };

        // Settings functionality
        const saveSettings = () => {
            const schoolName = document.getElementById('schoolName').value;
            
            const transaction = db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            
            // Save school name
            if (schoolName) {
                store.put({ key: 'schoolName', value: schoolName });
            }
            
            showNotification('تم حفظ الإعدادات بنجاح', 'success');
        };

        const loadSettings = () => {
            const transaction = db.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            
            // Load school name
            store.get('schoolName').onsuccess = (event) => {
                if (event.target.result) {
                    document.getElementById('schoolName').value = event.target.result.value;
                }
            };
        };

        const clearSettings = () => {
            showConfirmDialog('هل أنت متأكد من حذف جميع إعدادات المدرسة؟', () => {
                const transaction = db.transaction(['settings'], 'readwrite');
                const store = transaction.objectStore('settings');
                
                store.delete('schoolName');
                
                // Clear form
                document.getElementById('schoolName').value = '';
                
                showNotification('تم حذف الإعدادات بنجاح', 'success');
            });
        };

        const displayLogoPreview = (containerId, dataUrl) => {
            const container = document.getElementById(containerId);
            container.innerHTML = `<img src="${dataUrl}" class="logo-preview rounded border">`;
        };

        // Students functionality
        const addStudent = () => {
            const name = document.getElementById('studentName').value.trim();
            const stage = document.getElementById('studentStage').value;
            const classNum = document.getElementById('studentClass').value;
            const talentField = document.getElementById('talentField').value;
            const talentLevel = document.getElementById('talentLevel').value;
            const notes = document.getElementById('studentNotes').value.trim();
            
            if (!name || !stage || !classNum || !talentField || !talentLevel) {
                showAlert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            const student = {
                name,
                stage,
                classNum: parseInt(classNum),
                talentField,
                talentLevel,
                notes,
                createdAt: new Date().toISOString()
            };
            
            const transaction = db.transaction(['students'], 'readwrite');
            const store = transaction.objectStore('students');
            
            store.add(student).onsuccess = () => {
                clearForm();
                loadStudents();
                showNotification('تم إضافة الطالب بنجاح', 'success');
            };
        };

        const loadStudents = () => {
            const transaction = db.transaction(['students'], 'readonly');
            const store = transaction.objectStore('students');
            
            store.getAll().onsuccess = (event) => {
                const students = event.target.result;
                displayStudents(students);
            };
        };

        const displayStudents = (students) => {
            const container = document.getElementById('studentsList');
            
            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">لا توجد طلاب مسجلين حتى الآن</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg fade-in">
                    <div class="grid md:grid-cols-4 gap-4">
                        <div>
                            <strong class="text-primary">الاسم:</strong> ${student.name}
                        </div>
                        <div>
                            <strong class="text-primary">المرحلة:</strong> ${student.stage}
                        </div>
                        <div>
                            <strong class="text-primary">الصف:</strong> ${student.classNum}
                        </div>
                        <div>
                            <strong class="text-primary">مجال الموهبة:</strong> ${student.talentField}
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong class="text-primary">مستوى الموهبة:</strong> 
                        <span class="inline-block px-2 py-1 text-xs rounded-full ${getLevelColor(student.talentLevel || 'غير محدد')}">${student.talentLevel || 'غير محدد'}</span>
                    </div>
                    ${student.notes ? `<div class="mt-2"><strong class="text-primary">ملاحظات:</strong> ${student.notes}</div>` : ''}
                    <div class="flex justify-end mt-3">
                        <button onclick="deleteStudent(${student.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">حذف</button>
                    </div>
                </div>
            `).join('');
        };

        const deleteStudent = (id) => {
            showConfirmDialog('هل أنت متأكد من حذف هذا الطالب؟', () => {
                const transaction = db.transaction(['students'], 'readwrite');
                const store = transaction.objectStore('students');
                
                store.delete(id).onsuccess = () => {
                    loadStudents();
                    showNotification('تم حذف الطالب بنجاح', 'success');
                };
            });
        };

        const clearForm = () => {
            document.getElementById('studentName').value = '';
            document.getElementById('studentStage').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('talentField').value = '';
            document.getElementById('talentLevel').value = '';
            document.getElementById('studentNotes').value = '';
        };

        // Helper function for level colors
        const getLevelColor = (level) => {
            switch(level) {
                case 'ممتاز':
                    return 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100';
                case 'جيد جداً':
                    return 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100';
                case 'جيد':
                    return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100';
                case 'مقبول':
                    return 'bg-orange-100 text-orange-800 dark:bg-orange-800 dark:text-orange-100';
                default:
                    return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100';
            }
        };

        // Helper function for level badge colors in reports
        const getLevelBadgeColor = (level) => {
            switch(level) {
                case 'ممتاز':
                    return 'bg-green-500 text-white';
                case 'جيد جداً':
                    return 'bg-blue-500 text-white';
                case 'جيد':
                    return 'bg-yellow-500 text-white';
                case 'مقبول':
                    return 'bg-orange-500 text-white';
                default:
                    return 'bg-gray-500 text-white';
            }
        };

        // Reports functionality
        const generateReport = () => {
            const stageFilter = document.getElementById('filterStage').value;
            const talentFilter = document.getElementById('filterTalent').value;
            const levelFilter = document.getElementById('filterLevel').value;
            
            const transaction = db.transaction(['students', 'settings'], 'readonly');
            const studentsStore = transaction.objectStore('students');
            const settingsStore = transaction.objectStore('settings');
            
            // Get students
            studentsStore.getAll().onsuccess = (studentsEvent) => {
                const students = studentsEvent.target.result;
                
                // Get settings
                let schoolName = '';
                let schoolLogo = '';
                let ministryLogo = '';
                let completedRequests = 0;
                
                const checkComplete = () => {
                    completedRequests++;
                    if (completedRequests === 3) {
                        // Filter students
                        let filteredStudents = students;
                        if (stageFilter) {
                            filteredStudents = filteredStudents.filter(s => s.stage === stageFilter);
                        }
                        if (talentFilter) {
                            filteredStudents = filteredStudents.filter(s => s.talentField === talentFilter);
                        }
                        if (levelFilter) {
                            filteredStudents = filteredStudents.filter(s => s.talentLevel === levelFilter);
                        }
                        
                        displayReport(filteredStudents, schoolName, schoolLogo, ministryLogo);
                    }
                };
                
                // Get school name
                const schoolNameRequest = settingsStore.get('schoolName');
                schoolNameRequest.onsuccess = (event) => {
                    schoolName = event.target.result?.value || '';
                    checkComplete();
                };
                schoolNameRequest.onerror = () => {
                    checkComplete();
                };
                
                // Get school logo
                const schoolLogoRequest = settingsStore.get('schoolLogo');
                schoolLogoRequest.onsuccess = (event) => {
                    schoolLogo = event.target.result?.value || '';
                    checkComplete();
                };
                schoolLogoRequest.onerror = () => {
                    checkComplete();
                };
                
                // Get ministry logo
                const ministryLogoRequest = settingsStore.get('ministryLogo');
                ministryLogoRequest.onsuccess = (event) => {
                    ministryLogo = event.target.result?.value || '';
                    checkComplete();
                };
                ministryLogoRequest.onerror = () => {
                    checkComplete();
                };
            };
        };

        const displayReport = (students, schoolName, schoolLogo, ministryLogo) => {
            const container = document.getElementById('reportContent');
            const currentDate = new Date().toLocaleDateString('ar-SA');
            
            const headerLogos = `
                <div class="text-center mb-6" style="text-align: center; margin-bottom: 24px;">
                    <h1 class="text-2xl font-bold text-primary mb-2" style="font-size: 24px; font-weight: bold; color: #5D5CDE; margin-bottom: 8px;">المملكة العربية السعودية</h1>
                    <h2 class="text-xl font-semibold mb-1" style="font-size: 20px; font-weight: 600; margin-bottom: 4px;">وزارة التعليم</h2>
                    ${schoolName ? `<h3 class="text-lg font-medium" style="font-size: 18px; font-weight: 500;">${schoolName}</h3>` : ''}
                </div>
            `;
            
            const statsCards = generateStatsCards(students);
            
            const studentsTable = students.length > 0 ? `
                <div class="mt-8">
                    <h3 class="text-lg font-bold text-primary mb-4 text-center">قائمة الطلاب الموهوبين</h3>
                    <div class="w-full">
                        <div class="overflow-x-auto bg-white rounded-lg border border-gray-200 shadow-sm" style="max-width: 100%; margin: 0;">
                            <table class="w-full border-collapse" style="min-width: 800px;">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 50px;">#</th>
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 150px;">الاسم</th>
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 120px;">المرحلة</th>
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 70px;">الصف</th>
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 140px;">مجال الموهبة</th>
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 120px;">مستوى الموهبة</th>
                                        <th class="border border-gray-300 px-3 py-2 text-right whitespace-nowrap" style="min-width: 200px;">ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map((student, index) => `
                                        <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-100 transition-colors">
                                            <td class="border border-gray-300 px-3 py-2 text-center font-medium">${index + 1}</td>
                                            <td class="border border-gray-300 px-3 py-2 font-medium">${student.name}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-sm">${student.stage}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center font-medium">${student.classNum}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-sm">${student.talentField}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">
                                                <span class="inline-block px-2 py-1 text-xs rounded-full font-medium ${getLevelBadgeColor(student.talentLevel || 'غير محدد')}">${student.talentLevel || 'غير محدد'}</span>
                                            </td>
                                            <td class="border border-gray-300 px-3 py-2 text-sm" style="max-width: 200px; word-wrap: break-word;" title="${student.notes || '-'}">${student.notes || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center text-xs text-gray-500 p-2 bg-gray-50 border border-t-0 border-gray-200 rounded-b-lg">
                            <span class="inline-flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l4-4m0 0l4-4m-4 4v12"></path>
                                </svg>
                                مرر يميناً ويساراً لعرض جميع الأعمدة
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>
            ` : '<p class="text-center text-gray-500 mt-8">لا توجد بيانات متاحة للعرض</p>';
            
            container.innerHTML = `
                <div class="p-8">
                    ${headerLogos}
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-primary mb-2">تقرير الطلاب الموهوبين</h2>
                        <p class="text-gray-600">تاريخ التقرير: ${currentDate}</p>
                    </div>
                    ${statsCards}
                    ${studentsTable}
                    <div class="mt-8 pt-4 border-t border-gray-200 text-center text-sm text-gray-500">
                        تم إنشاء هذا التقرير بواسطة نظام إدارة الموهوبين - ${currentDate}
                    </div>
                </div>
            `;
        };

        const generateStatsCards = (students) => {
            const totalStudents = students.length;
            const stageStats = {};
            const talentStats = {};
            const levelStats = {};
            
            students.forEach(student => {
                stageStats[student.stage] = (stageStats[student.stage] || 0) + 1;
                talentStats[student.talentField] = (talentStats[student.talentField] || 0) + 1;
                const level = student.talentLevel || 'غير محدد';
                levelStats[level] = (levelStats[level] || 0) + 1;
            });
            
            const topStage = Object.keys(stageStats).reduce((a, b) => stageStats[a] > stageStats[b] ? a : b, '');
            const topTalent = Object.keys(talentStats).reduce((a, b) => talentStats[a] > talentStats[b] ? a : b, '');
            const excellentCount = levelStats['ممتاز'] || 0;
            
            return `
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-primary text-white p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold">إجمالي الطلاب</h4>
                        <p class="text-2xl font-bold">${totalStudents}</p>
                    </div>
                    <div class="bg-secondary text-white p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold">أكثر المراحل</h4>
                        <p class="text-sm font-medium">${topStage || '-'}</p>
                        <p class="text-lg font-bold">${stageStats[topStage] || 0}</p>
                    </div>
                    <div class="bg-amber-500 text-white p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold">أكثر المجالات</h4>
                        <p class="text-sm font-medium">${topTalent || '-'}</p>
                        <p class="text-lg font-bold">${talentStats[topTalent] || 0}</p>
                    </div>
                    <div class="bg-green-600 text-white p-4 rounded-lg text-center">
                        <h4 class="text-lg font-semibold">الطلاب الممتازون</h4>
                        <p class="text-2xl font-bold">${excellentCount}</p>
                        <p class="text-xs opacity-80">${totalStudents > 0 ? Math.round((excellentCount / totalStudents) * 100) : 0}%</p>
                    </div>
                </div>
                
                ${students.length > 0 ? `
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h5 class="text-md font-semibold text-primary mb-3">توزيع مستويات الموهبة</h5>
                        <div class="space-y-2">
                            ${Object.entries(levelStats).map(([level, count]) => `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">${level}</span>
                                    <span class="font-bold ${level === 'ممتاز' ? 'text-green-600' : level === 'جيد جداً' ? 'text-blue-600' : level === 'جيد' ? 'text-yellow-600' : 'text-orange-600'}">${count} (${Math.round((count / totalStudents) * 100)}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h5 class="text-md font-semibold text-primary mb-3">توزيع مجالات الموهبة</h5>
                        <div class="space-y-2">
                            ${Object.entries(talentStats).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([talent, count]) => `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">${talent}</span>
                                    <span class="font-bold text-primary">${count} (${Math.round((count / totalStudents) * 100)}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        };

        // Utility functions
        const showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white z-50 fade-in ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };

        const showAlert = (message) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded" onclick="this.closest('.fixed').remove()">موافق</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        const showConfirmDialog = (message, onConfirm) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded ml-2">إلغاء</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">تأكيد</button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const cancelBtn = modal.querySelector('.cancel-btn');
            const confirmBtn = modal.querySelector('.confirm-btn');
            
            cancelBtn.addEventListener('click', () => {
                modal.remove();
            });
            
            confirmBtn.addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            document.body.appendChild(modal);
        };

        // Print functionality
        const printReport = () => {
            window.print();
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initDB();
            initTabs();
            populateClassNumbers();
            
            // Settings events
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('clearSettings').addEventListener('click', clearSettings);
            
            // Students events
            document.getElementById('addStudent').addEventListener('click', addStudent);
            document.getElementById('clearForm').addEventListener('click', clearForm);
            
            // Reports events
            document.getElementById('filterStage').addEventListener('change', generateReport);
            document.getElementById('filterTalent').addEventListener('change', generateReport);
            document.getElementById('filterLevel').addEventListener('change', generateReport);
            document.getElementById('printReport').addEventListener('click', printReport);
        });
    </script>
</body>
</html>
